import{getNextVisibleItemPosition as e,getPreviousVisibleItemPosition as t,isElementVisible as o,getOpenPopup as r,selectors as n}from"./utils.js";import{closeAllDropdowns as s,dropWhile as i,logErrorFor as a,setActiveDropdown as l,takeWhile as c}from"../utilities.js";const u=()=>{const e=[...document.querySelectorAll(`${n.headline}[aria-expanded="true"]`)];e.forEach((e=>e.setAttribute("aria-expanded","false"))),l(e[0])},d=({headline:e,focus:t}={})=>{if(u(),"true"===e.getAttribute("aria-haspopup")){e.setAttribute("aria-expanded","true"),l(e);const r=[...(e.closest(n.section)||e.closest(n.column)||e.closest(n.featuredProducts)).querySelectorAll(n.popupItems)].filter((e=>o(e)));"first"===t&&r[0].focus(),"last"===t&&r[r.length-1].focus()}},p=(e=r())=>{if(!e)return{popupItems:[]};const t=[...e.querySelectorAll(n.popupItems)],s=document.activeElement.closest(n.section)||document.activeElement.closest(n.column);let i=[...e.querySelectorAll(n.section)];i.length||(i=[...e.querySelectorAll(n.column)]);const a=i.filter((e=>o(e))),l=a.findIndex((e=>e.isEqualNode(s))),c=a[0]?.querySelector(n.headline),u=a[a.length-1]?.querySelector(n.headline),d=a[l-1]?.querySelector(n.headline),p=a[l+1]?.querySelector(n.headline);return{visibleSections:a,currentSection:l,firstHeadline:c,lastHeadline:u,prevHeadline:d,nextHeadline:p,popupItems:t}};export default class{constructor({mainNav:e}){this.mainNav=e,this.addEventListeners(),this.desktop=window.matchMedia("(min-width: 900px)")}open({focus:o}={}){const{firstHeadline:r,lastHeadline:n,popupItems:s}=p();if(!s.length)return;const i="last"===o?n:r;i&&"true"===i.getAttribute("aria-haspopup")&&(u(),i.setAttribute("aria-expanded","true"));const a=e(-1,s),c=t(s.length,s);"first"===o&&s[a].focus(),"last"===o&&s[c].focus(),l("first"===o?s[a]:s[c])}mobileArrowUp=({prev:e,curr:t,element:o,isFooter:r,newNav:s})=>{const i=p(o),{currentSection:a}=i,l=s&&!r?this.popupItems():i.popupItems;if(-1!==e&&t-1===e)return l[e].focus(),void(a!==p(o).currentSection&&u());const{prevHeadline:c}=p(o);if(c||s||r)if(c||!r)s&&!r?l?.[l.length-1]?.focus():d({headline:c,focus:"last"});else{const e=o?.previousElementSibling,t=[...e.querySelectorAll(n.headline)];t.length&&t[t.length-1]&&(u(),d({headline:t[t.length-1],focus:"last"}))}else this.focusMainNav(r)};mobileArrowDown=({next:e,element:t,isFooter:o,newNav:r})=>{const n=p(t),{currentSection:s}=n,i=r&&!o?this.popupItems():n.popupItems;if(-1!==e)return i[e].focus(),void(s!==p(t).currentSection&&u());const{nextHeadline:a}=p(t);if(!a&&!r&&!o)return u(),void this.focusMainNavNext(o);if(!a&&o){const e=t?.nextElementSibling,o=e&&e.querySelector(".feds-menu-headline");return u(),void(o?d({headline:o,focus:"first"}):e?.querySelector("a")?.focus())}r&&!o?i?.[0]?.focus():d({headline:a,focus:"first"})};focusMainNav=e=>{e||this.mainNav.focusCurr()};focusMainNavNext=e=>{e||(this.mainNav.focusNext(),this.mainNav.open())};popupItems=()=>{const e=document.querySelector(n.activePopup);if(!e)return[];const t=[...e.querySelectorAll(n.tab)],o=t.find((e=>"true"===e.getAttribute("aria-selected"))),r=c(t,(e=>e!==o)),s=i(t,(e=>e!==o)).slice(1),a=[...e.querySelectorAll(n.activeLinks)],l=e.querySelector(n.stickyCta),u=e.querySelectorAll(n.topBarLinks),d=e.querySelectorAll(n.breadCrumbItems);return[...r,o,...a,l,...s,...u,...d].filter(Boolean)};handleKeyDown=({e:o,element:r,isFooter:i})=>{const a=!!document.querySelector("header.new-nav"),l=!!document.querySelector("header.local-nav"),c=a&&!i?this.popupItems():[...r.querySelectorAll(n.popupItems)],f=c.findIndex((e=>e===o.target)),h=t(f,c),m=e(f,c);switch(o.preventDefault(),o.stopPropagation(),o.code){case"Tab":o.shiftKey?this.mobileArrowUp({prev:h,curr:f,element:r,isFooter:i,newNav:a}):this.mobileArrowDown({curr:f,next:m,element:r,isFooter:i,newNav:a});break;case"Escape":if(s(),this.focusMainNav(i),a&&l&&!i){const e=document.querySelector("header.new-nav .feds-toggle");e?.click(),e?.focus()}break;case"ArrowLeft":{if(a)break;const{prevHeadline:e,nextHeadline:t}=p(r),o="rtl"!==document.dir?e:t;if(!o){i||u(),"rtl"!==document.dir?this.focusMainNav(i):this.focusMainNavNext(i);break}d({headline:o,focus:"first"});break}case"ArrowUp":if(a)break;this.mobileArrowUp({prev:h,curr:f,element:r,isFooter:i});break;case"ArrowRight":{if(a)break;const{prevHeadline:e,nextHeadline:t}=p(r),o="rtl"!==document.dir?t:e;if(!o){i||u(),"rtl"!==document.dir?this.focusMainNavNext(i):this.focusMainNav(i);break}d({headline:o,focus:"first"});break}case"ArrowDown":if(a)break;this.mobileArrowDown({next:m,element:r,isFooter:i})}};addEventListeners=()=>{document.querySelector(n.globalNavTag)?.addEventListener("keydown",(e=>a((()=>{if(!e.target.closest(n.globalNav))return;const t=r();e.target.closest(n.popup)&&t&&!this.desktop.matches&&this.handleKeyDown({e,element:t,popupEl:t,isFooter:!1})}),`popup key failed ${e.code}`,"gnav-keyboard","e"))),document.querySelector(n.globalFooterTag)?.addEventListener("keydown",(e=>a((()=>{if(!e.target.closest(n.globalFooter))return;const t=e.target.closest(n.menuContent)||e.target.closest(n.featuredProducts);if(!t||this.desktop.matches)return;const o=t.querySelector(n.popupItems),r=t.querySelector(n.headline),s=e.target===o,i=e.target===r;return e.shiftKey&&(s||i)&&!e.target.closest(n.featuredProducts)?void 0:e.target.closest(n.headline)?(d({headline:e.target.closest(n.headline),focus:"first"}),e.preventDefault(),void e.stopPropagation()):void this.handleKeyDown({e,element:t,isFooter:!0})}),`footer key failed ${e.code}`,"gnav-keyboard","e")))}}
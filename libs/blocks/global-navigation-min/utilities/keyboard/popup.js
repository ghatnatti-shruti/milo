import{getNextVisibleItemPosition as e,getPreviousVisibleItemPosition as t,getOpenPopup as o,selectors as r}from"./utils.js";import{closeAllDropdowns as s,logErrorFor as a}from"../utilities.js";export default class{constructor({mainNav:e}){this.mainNav=e,this.addEventListeners(),this.desktop=window.matchMedia("(min-width: 900px)")}open({focus:s}={}){const a=[...o()?.querySelectorAll(r.popupItems)||[]];if(!a.length)return;const n=e(-1,a),i=t(a.length,a);"first"===s&&a[n].focus(),"last"===s&&a[i].focus()}focusMainNav=e=>{e||this.mainNav.focusCurr()};focusMainNavNext=e=>{if(e)return;const{next:t}=this.mainNav.getState();if(t>=0)return this.mainNav.focusNext(),void this.mainNav.open();s(),this.mainNav.focusCurr()};handleKeyDown=({e:o,element:a,isFooter:n})=>{const{popupItems:i,prev:c,next:u,prevColumn:l,nextColumn:p}=(({e:o,element:s}={})=>{if(!s)return{};const a=[...s.querySelectorAll(r.popupItems)],n=a.findIndex((e=>e===o.target)),i=document.activeElement.closest(r.column),c=[...s.querySelectorAll(r.column)],u=c.findIndex((e=>e.isEqualNode(i)));return{popupItems:a,curr:n,prev:t(n,a),next:e(n,a),prevColumn:c[u-1],nextColumn:c[u+1]}})({e:o,element:a}),f=n&&"Tab"===o.code&&o.shiftKey&&-1===c;if(!(n&&"Tab"===o.code&&!o.shiftKey&&-1===u)&&!f)switch(o.preventDefault(),o.stopPropagation(),o.code){case"Tab":if(o.shiftKey){if(-1===c){this.focusMainNav(n);break}i[c].focus()}else{if(-1===u){this.focusMainNavNext(n);break}i[u].focus()}break;case"Escape":s(),this.focusMainNav(n);break;case"ArrowLeft":{const e="rtl"!==document.dir&&!l?.querySelector(r.popupItems),t="rtl"===document.dir&&!p?.querySelector(r.popupItems);if(e||t){this.focusMainNav(n);break}"rtl"!==document.dir?l.querySelector(r.popupItems).focus():p.querySelector(r.popupItems).focus();break}case"ArrowUp":if(-1===c){this.focusMainNav(n);break}i[c].focus();break;case"ArrowRight":{const e="rtl"!==document.dir&&!p?.querySelector(r.popupItems),t="rtl"===document.dir&&!l?.querySelector(r.popupItems);if(e||t){this.focusMainNav(n);break}"rtl"!==document.dir?p.querySelector(r.popupItems).focus():l.querySelector(r.popupItems).focus();break}case"ArrowDown":if(-1===u){this.focusMainNavNext(n);break}i[u].focus()}};addEventListeners=()=>{document.querySelector(r.globalNavTag)?.addEventListener("keydown",(e=>a((()=>{if(!e.target.closest(r.globalNav))return;const t=o();e.target.closest(r.popup)&&t&&this.desktop.matches&&this.handleKeyDown({e,element:t,isFooter:!1})}),`popup key failed ${e.code}`,"gnav-keyboard","e"))),document.querySelector(r.globalFooterTag)?.addEventListener("keydown",(e=>a((()=>{if(!e.target.closest(r.globalFooter))return;if(!this.desktop.matches)return;const t=e.target.closest(r.globalFooter);this.handleKeyDown({e,element:t,isFooter:!0})}),`footer key failed ${e.code}`,"gnav-keyboard","e")))}}
import{getNextVisibleItemPosition as e,getPreviousVisibleItemPosition as t,selectors as a}from"./utils.js";import o from"./mainNav.js";import{closeAllDropdowns as r,lanaLog as n,logErrorFor as s}from"../utilities.js";const i=({e})=>{const t=document.querySelectorAll(a.profileDropdown);if(!t.length)return{next:-1,prev:-1,items:[]};const o=[...t],r=o.findIndex((t=>t===e.target));return{next:r+1,prev:r-1,curr:r,items:o}},c=()=>{r(),document.querySelector(`${a.profileButton}, ${a.signIn}`)?.focus()};export default class{constructor(e){try{this.addEventListeners(),this.mainNav=new o,e&&this.loadLnavNavigation(),this.desktop=window.matchMedia("(min-width: 900px)")}catch(e){n({message:"Keyboard Navigation failed to load",e,tags:"gnav-keyboard",errorType:"e"})}}loadLnavNavigation=async()=>(this.localNav||(this.localNav=(async()=>{try{const{default:e}=await import("./localNav.js");return new e}catch(e){return n({message:"Keyboard Navigation failed to load for LNAV",e,tags:"gnav-keyboard",errorType:"i"}),null}})()),this.localNav);addEventListeners=()=>{[...document.querySelectorAll(`${a.globalNavTag}, ${a.globalFooterTag}`)].forEach((o=>{o.addEventListener("keydown",(r=>s((()=>{if(r.target.closest(`${a.globalNav}, ${a.globalFooter}`))switch(r.code){case"Tab":{const o=!!document.querySelector("header.new-nav"),n=document.querySelector(a.navWrapper).classList.contains(a.navWrapperExpanded.slice(1));if(o&&n){if(r.target.classList.contains(a.mainNavToggle.slice(1)))if(r.preventDefault(),r.shiftKey){const e=[...document.querySelectorAll(`${a.mainMenuItems}, ${a.mainMenuLinks}`)];e.at(-1)?.focus()}else document.querySelector(`${a.mainMenuItems}, ${a.mainMenuLinks}`)?.focus()}else{(({e:o,isDesktop:r})=>{const n=[...document.querySelectorAll(`\n      ${a.brand},\n      ${a.mainNavToggle},\n      ${a.mainNavItems},\n      ${a.searchTrigger},\n      ${a.searchField},\n      ${a.signIn},\n      ${a.profileButton},\n      ${a.logo}\n  `)],s=e(-1,n),i=t(n.length,n);r&&document.querySelector(a.openSearch)&&document.activeElement===n[o.shiftKey?s:i]&&(o.preventDefault(),n[o.shiftKey?i:s].focus())})({e:r,isDesktop:this.desktop.matches});const{items:o}=i({e:r}),n=r.target.closest(`${a.signIn}, ${a.profileButton}`);r.shiftKey&&r.target===n&&c(),o[o.length-1]===r.target&&(r.preventDefault(),r.stopPropagation(),c())}break}case"Escape":{const e=document.querySelector("header.new-nav .feds-toggle");e&&e===r.target&&"true"===e.getAttribute("aria-expanded")&&(e.click(),e.focus());break}case"Enter":case"Space":if(r.target.closest(a.searchField)||r.target.closest(".feds-client-search"))return;r.stopPropagation(),r.preventDefault(),r.target.click();break;case"ArrowDown":if(r.target.closest(a.profile)){if((({e,el:t})=>{const o=e.target.closest(`${a.signIn}, ${a.profileButton}`);return"false"===o?.getAttribute("aria-expanded")&&(e.target.click(),t.querySelector(a.profileDropdown)?.focus(),!0)})({e:r,el:o}))break;(({e})=>{const{items:t,next:a}=i({e});t[a]?t[a].focus():(e.preventDefault(),e.stopPropagation(),c())})({e:r})}break;case"ArrowUp":r.target.closest(a.profile)&&(({e})=>{const{items:t,prev:a}=i({e});t[a]?t[a].focus():(e.preventDefault(),e.stopPropagation(),c())})({e:r})}}),`KeyboardNavigation index failed. ${r.code}`,"gnav-keyboard","e")))}))}}
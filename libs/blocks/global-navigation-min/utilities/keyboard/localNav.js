import{selectors as e,getNextVisibleItemPosition as t,getPreviousVisibleItemPosition as a}from"./utils.js";import{trigger as r}from"../utilities.js";const l=e=>[...e.querySelectorAll("a[href],button:not([disabled])")],s=e=>[...e.querySelectorAll("a, button, .feds-menu-headline")].filter((e=>{const t=e.closest(".feds-menu-items"),a=t?.previousElementSibling;return!t||"true"===a?.getAttribute("aria-expanded")}));function n({triggerEl:l,e:s}={}){const{items:n,curr:o}=function(){const r=[...document.querySelectorAll(e.localNavItems)],l=document.querySelector(e.expandedPopupTrigger),s=document.activeElement.closest(e.localNavItem)?.querySelector(e.localNavItems),n=r.indexOf(s);return{items:r,curr:n,prev:a(n,r),next:t(n,r),openTrigger:l}}(),c=l||n[o];if(c?.hasAttribute("aria-haspopup")&&(s&&s.preventDefault(),"false"===c.getAttribute("aria-expanded"))){const t=c.classList.contains("feds-localnav-title")||c.classList.contains("feds-menu-headline");t&&document.querySelector(e.localNav).classList.add("feds-localnav--active"),r({element:c,type:t?"headline":"localNavItem"})}}function o(t,a){const r=[...document.querySelector(".feds-localnav-items").children].flatMap((e=>{const t=e.querySelector("a, button, .feds-menu-headline");if(!t||!t.matches('[aria-haspopup="true"][aria-expanded="true"]'))return t?[t]:[];const a=e.querySelector(".feds-popup");return a?[t,...e.querySelector(".feds-menu-items")?s(a):l(a)]:[t]})),o=r.indexOf(t),c=t.classList.contains("feds-localnav-title"),i=document.querySelector(`${e.localNav} > button`);if(-1===o&&!c)return;if(c&&1===a&&n({triggerEl:t}),1===a&&t===r.at(-1)||-1===a&&t===r.at(0))return void i?.focus();if(-1===a&&c)return void r.at(-1)?.focus();const u=r[(o+a+r.length)%r.length];if(u.focus(),u.matches('[aria-haspopup="true"]')){const e=u.matches('[aria-expanded="false"]');if(n({triggerEl:u}),-1===a&&e){const e=u.parentElement.querySelector(".feds-menu-items")?s(u.parentElement):l(u.parentElement.querySelector(".feds-popup"));e.at(-1)?.focus()}}}export default class{constructor(){this.localNav=document.querySelector(e.localNav),this.localNavTrigger=this.localNav?.querySelector(e.localNavTitle),this.exitLink=this.localNav?.querySelector(e.localNavExit),this.addEventListeners()}handleKeyDown=t=>{const{code:a,target:l}=t,s=l.classList.contains(e.headline.slice(1));switch(a){case"Space":case"Enter":t.stopPropagation(),t.preventDefault(),s?r({element:l,event:t,type:"headline"}):t.target.click();break;case"Escape":t.preventDefault(),this.localNav.classList.contains(e.localNavActive.slice(1))&&(this.localNavTrigger?.click(),this.localNavTrigger?.focus());break;case"ArrowDown":case"ArrowUp":t.stopPropagation(),t.preventDefault();o(l,"ArrowDown"===a?1:-1);break}};addEventListeners=()=>{this.localNav?.addEventListener("keydown",this.handleKeyDown),this.exitLink?.addEventListener("focus",(e=>{e.preventDefault(),this.localNavTrigger?.focus()}))}}